<?php
 header("Content-type: text/html; charset=UTF-8"); session_start(); class SendMessEmail { private $user_email = null; private $user_id = null; public function __construct() { if(!empty($_POST['ok_email']) AND $this->validEmail($_POST['ok_email'])){ $this->user_id = intval($_SESSION['ok_user_id']); $this->user_email = $_POST['ok_email']; require 'libmail.php'; require 'mysql.php'; }else { die('Не правильный e-mail'); } } public function getMessageList() { $mysql = Mysql::getInstance(); $sql = "SELECT * FROM ok_messages WHERE id_user = {$this->user_id} ORDER BY wr_date"; $result = $mysql->query($sql); if($result->columnCount() == 0){ die('Пустой диалог с консультантом!'); }else{ $message_list = "<h3>Диалог с консультантом</h3>"; while($message = $result->fetch(PDO::FETCH_ASSOC)){ $wr_time = date("Y-m-d H:i:s", $message['wr_date']); if($message['is_from'] == 1){ $message_list .= '<div class="message_guest" style="border-bottom: 1px solid #696969; padding: 5px;">Вы - '.$wr_time.'<p>'.$message['messages'].'</p></div>'; }elseif($message['is_from'] == 2){ $message_list .= '<div class="message_operator" style="border-bottom: 1px solid #696969; padding: 5px;">Консультант - '.$wr_time.'<p>'.$message['messages'].'</p></div>'; }elseif($message['is_from'] == 0){ } } return $message_list; } } public function validEmail($email){ $pattern = '/\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6}/'; if(preg_match($pattern, $email) != 1){ return false; }else{ return true; } } public function sendMessList() { $message = $this->getMessageList(); $m = new Mail('UTF-8'); $m->From("online-консультант"); $m->To($this->user_email); $m->Subject("Диалог с консультантом"); $m->Body($message, "html"); $m->Priority(3) ; $m->Send(); die('Диалог отправлен на '. $this->user_email); } } if(isset($_SESSION['ok_user_id'])) { $message = new SendMessEmail(); $message->sendMessList(); }else { die('Пользователь не найден!'); } ?>