<?php
 header("Content-type: text/html; charset=UTF-8"); error_reporting(0); class GetMessList{ public $user_name; public $user_id; public $operator_name; public function __construct(){ if(isset($_COOKIE['ok_user_id'])){ $user_cookie = explode('$', $_COOKIE['ok_user_id']); $this->user_id = intval($user_cookie[0]); session_start(); if(isset($_SESSION['ok_user_id'])){ if($_SESSION['ok_user_id'] != $this->user_id) exit; } if(isset($_COOKIE['ok_user_name'])) $this->user_name = strip_tags($_COOKIE['ok_user_name']); else $this->user_name = "Гость"; if(isset($_COOKIE['operator_name'])) $this->operator_name = strip_tags($_COOKIE['operator_name']); else $this->operator_name = "Консультант"; }else{ die(false); } } public function getList(){ require 'mysql.php'; $sql = "SELECT * FROM ok_messages WHERE id_user = {$this->user_id} ORDER BY wr_date"; $mysql = Mysql::getInstance(); $result = $mysql->query($sql); if($result->rowCount() > 0){ $html = ""; while($message = $result->fetch(PDO::FETCH_ASSOC)){ $wr_time = date("H:i:s", $message['wr_date']); if($message['is_from'] == 1){ $html .= '<div class="message_guest"><div class="message_guest_t"></div><div class="message_guest_s"><div class="message_guest_i"><div class="message_guest_n">'.$this->user_name.'</div><div class="message_guest_v">'.$wr_time.'</div></div>'.$message['messages'].'</div><div class="message_guest_b"></div></div>'; }elseif($message['is_from'] == 2){ $html .= '<div class="message_operator"><div class="message_operator_t"></div><div class="message_operator_s"><div class="message_operator_i"><div class="message_operator_n">'.$this->operator_name.'</div><div class="message_operator_v">'.$wr_time.'</div></div><span>'.$message['messages'].'</span></div><div class="message_operator_b"></div></div>'; }elseif($message['is_from'] == 0){ } } $this->updateNew(); echo $html; exit; }else{ exit(); } } private function updateNew(){ if(isset($_COOKIE['chat_init'])){ $sql = "UPDATE ok_users_chat SET new_message_operator = '0' WHERE id_user = {$this->user_id}"; $mysql = Mysql::getInstance(); $mysql->exec($sql); } } } $get_list = new GetMessList(); $get_list->getList(); ?>
