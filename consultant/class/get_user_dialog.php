<?php
 header("Content-type: text/html; charset=UTF-8"); class GetUserDialog { public $id_user; public $operator_name = "Консультант"; public $user_name; public function __construct() { if(!empty($_POST['id_user'])){ $this->id_user = intval($_POST['id_user']); } } public function get() { require 'mysql.php'; $sql = "SELECT * FROM ok_messages WHERE id_user = {$this->id_user} ORDER BY wr_date"; $mysql = Mysql::getInstance(); $result = $mysql->query($sql); if($result->rowCount() > 0){ $html = ""; $con_id = 0; while($message = $result->fetch(PDO::FETCH_ASSOC)){ $wr_time = date("H:i:s", $message['wr_date']); $this->user_name = "Клиент ".$message['id_user']; if($con_id == 0 OR $con_id != $message['is_for']){ $sql = "SELECT operator_name FROM ok_operators WHERE operator_id = {$message['is_for']} LIMIT 1"; $result_op = $mysql->query($sql); $op = $result_op->fetch(2); $this->operator_name = $op['operator_name']; }else{ $con_id = $message['is_for']; } if($message['is_from'] == 1){ $html .= '<div class="message_guest"><div class="message_guest_t"></div><div class="message_guest_s"><div class="message_guest_i"><div class="message_guest_n">'.$this->user_name.'</div><div class="message_guest_v">'.$wr_time.'</div></div>'.$message['messages'].'</div><div class="message_guest_b"></div></div>'; }elseif($message['is_from'] == 2){ $html .= '<div class="message_operator"><div class="message_operator_t"></div><div class="message_operator_s"><div class="message_operator_i"><div class="message_operator_n">'.$this->operator_name.'</div><div class="message_operator_v">'.$wr_time.'</div></div><span>'.$message['messages'].'</span></div><div class="message_operator_b"></div></div>'; }elseif($message['is_from'] == 0){ } } echo $html; exit; }else{ die("false"); } } } session_start(); if(isset($_SESSION['who']) AND $_SESSION['who'] == "admin"){ $dialog = new GetUserDialog(); $dialog->get(); }else{ die('Нет прав администратора!'); } ?>