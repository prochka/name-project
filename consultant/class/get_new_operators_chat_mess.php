<?php
 header("Content-type: application/json"); class getNewOperatorsChatMess{ static function getChatMess($last_message){ require 'mysql.php'; $sql = "SELECT chat.*, ok_operators.operator_name, ok_operators.operator_photo  FROM ok_operators_chat AS chat, ok_operators WHERE id_mess > {$last_message} AND ok_operators.operator_id = chat.id_operator ORDER BY chat.wr_date DESC LIMIT 50"; $mysql = Mysql::getInstance(); $result = $mysql->query($sql); if($messages = $result->fetchAll(PDO::FETCH_ASSOC)){ for($i = 0; $i < count($messages); $i++){ $messages[$i]['wr_date'] = date("H:i:s", $messages[$i]['wr_date']); } $messages = array_reverse($messages); return json_encode($messages); }else exit; } } session_start(); if(isset($_SESSION['who']) AND $_SESSION['who'] == "operator"){ if(isset($_POST['last_message'])){ $last_message = intval($_POST['last_message']); echo getNewOperatorsChatMess::getChatMess($last_message); exit; }else die('last_message'); }else{ die('Error! Нельзя обращаться к файлу напрямую'); } ?>
