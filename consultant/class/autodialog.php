<?php
 class GetAutodialog{ private $user_ip; public function __construct() { $this->user_ip = ip2long($this->getIp()); require 'mysql.php'; } public function autodialog(){ $mysql = Mysql::getInstance(); $sql = "SELECT id_operator, message FROM ok_autodialog WHERE ip_user = '{$this->user_ip}'"; $result = $mysql->query($sql); if($result->rowCount() > 0){ if(isset($_POST['user_ip'])){ return true; } $operator_message = $result->fetch(PDO::FETCH_ASSOC); $operator_info = $this->getAutodialogOperator($operator_message['id_operator']); $operator = array_merge($operator_message, $operator_info); echo json_encode($operator); exit; }else{ return false; } } public function addAutodialog($user_ip, $message){ $this->user_ip = $user_ip; if($this->autodialog() === false){ session_start(); $mysql = Mysql::getInstance(); $message = $mysql->quote($message); $sql = "INSERT INTO ok_autodialog VALUES('{$this->user_ip}', {$_SESSION['operator_id']}, {$message})"; if($mysql->exec($sql)){ echo 'Приглашение отправлено'; } }else{ die('Уже был приглашен'); } } public function getAutodialogOperator($id_operator){ $mysql = Mysql::getInstance(); $id_operator = intval($id_operator); $sql = "SELECT ok_operators.operator_id, ok_operators.operator_name, ok_operators.operator_surname, ok_operators.operator_photo, ok_group.group_name AS operator_otdel FROM ok_operators, ok_group WHERE operator_id = {$id_operator} AND ok_group.group_id = ok_operators.operator_otdel"; $result = $mysql->query($sql); if($result->columnCount() == 0){ echo false; exit; }else{ return $result->fetch(PDO::FETCH_ASSOC); } } public function getIp(){ if (isset($_SERVER['REMOTE_ADDR']))return $_SERVER['REMOTE_ADDR']; if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) return trim(strtok($_SERVER['HTTP_X_FORWARDED_FOR'], ',')); if (isset($_SERVER['HTTP_CLIENT_IP'])) return $_SERVER['HTTP_CLIENT_IP']; if (isset($_SERVER['HTTP_X_REAL_IP'])) return $_SERVER['HTTP_X_REAL_IP']; } } if(isset($_POST['user_ip'])){ header("Content-type: text/html; charset=UTF-8"); $autodialog = new GetAutodialog(); $autodialog->addAutodialog($_POST['user_ip'], $_POST['message']); }else{ header("Content-type: application/json"); $autodialog = new GetAutodialog(); $autodialog->autodialog(); } ?>
