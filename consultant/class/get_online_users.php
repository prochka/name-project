<?php
 header("Content-type: application/json"); require 'mysql.php'; class GetOnlineUsers{ static public function onlineUsers(){ $sql = "SELECT user_ip, ctime, country FROM ok_online ORDER BY ctime"; $mysql = Mysql::getInstance(); $result = $mysql->query($sql); if($users = $result->fetchAll(PDO::FETCH_ASSOC)){ foreach($users as $k=>$v){ $users[$k]['ip'] = long2ip($users[$k]['user_ip']); } return json_encode($users); }else exit; } static public function onlineUsersCount(){ $sql = "SELECT COUNT(user_ip) AS count FROM ok_online"; $mysql = Mysql::getInstance(); $result = $mysql->query($sql); if($users = $result->fetch(PDO::FETCH_ASSOC)){ return json_encode($users); }else exit; } static public function delOfflineIp(){ $mysql = Mysql::getInstance(); $del_time = time() - 150; $sql = "SELECT user_ip FROM ok_online WHERE ltime < '{$del_time}'"; $res = $mysql->query($sql); if($res->columnCount() == 0){ return; }else{ while($del_ip = $res->fetch(PDO::FETCH_ASSOC)){ $sql = "DELETE FROM ok_online WHERE user_ip = {$del_ip['user_ip']}"; $mysql->exec($sql); $sql = "DELETE FROM ok_moving WHERE user_ip = {$del_ip['user_ip']}"; $mysql->exec($sql); $sql = "DELETE FROM ok_autodialog WHERE ip_user = {$del_ip['user_ip']}"; $mysql->exec($sql); } } } } session_start(); if(isset($_SESSION['who'])){ if(isset($_POST['get_count'])){ GetOnlineUsers::delOfflineIp(); echo GetOnlineUsers::onlineUsersCount(); exit; }else{ echo GetOnlineUsers::onlineUsers(); exit; } }else exit; ?>
